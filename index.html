<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Penlight Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

#screen {
  width: 100%;
  height: 100%;
  background: black;
}

#hint {
  position: fixed;
  bottom: 10px;
  width: 100%;
  text-align: center;
  color: rgba(255,255,255,0.6);
  font-size: 12px;
}
</style>
</head>

<body>
<div id="screen"></div>
<div id="hint">ã‚¿ãƒƒãƒ—ã—ã¦ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„</div>

<script>
const screen = document.getElementById("screen");
const hint = document.getElementById("hint");

// ğŸ¨ ãƒšãƒ³ãƒ©ã‚¤ãƒˆç”¨ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆç™½å°‘ãªã‚ï¼‰
const palette = [
  { h: 200, s: 85, l: 65 }, // æ°´è‰²
  { h: 50,  s: 95, l: 65 }, // é»„è‰²
  { h: 30,  s: 95, l: 60 }, // ã‚ªãƒ¬ãƒ³ã‚¸
  { h: 330, s: 85, l: 65 }, // ãƒ”ãƒ³ã‚¯
  { h: 270, s: 75, l: 65 }  // ç´«
];

let audioContext, analyser, dataArray;
let smoothVolume = 0;
let glow = 0;

async function startMic() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const source = audioContext.createMediaStreamSource(stream);

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 512;

  dataArray = new Uint8Array(analyser.fftSize);
  source.connect(analyser);

  hint.style.display = "none";
  animate();
}

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function getColor(t) {
  const n = palette.length - 1;
  const i = Math.floor(t * n);
  const f = t * n - i;

  const c1 = palette[i];
  const c2 = palette[Math.min(i + 1, n)];

  return {
    h: lerp(c1.h, c2.h, f),
    s: lerp(c1.s, c2.s, f),
    l: lerp(c1.l, c2.l, f)
  };
}

function animate() {
  analyser.getByteTimeDomainData(dataArray);

  let sum = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const v = (dataArray[i] - 128) / 128;
    sum += v * v;
  }
  const volume = Math.sqrt(sum / dataArray.length);

  // ğŸš éŸ³é‡ã‚’ã‹ãªã‚Šèª‡å¼µ
  smoothVolume = smoothVolume * 0.85 + volume * 0.15;
  const boosted = Math.pow(smoothVolume * 7, 1.3);

  // âœ¨ æ®‹å…‰ï¼ˆãƒšãƒ³ãƒ©ã‚¤ãƒˆæ„Ÿã®æ ¸ï¼‰
  glow = glow * 0.85 + boosted * 0.15;

  // ğŸŒˆ è‰²ã¯ã‚†ã£ãã‚Šæ¼‚ã†
  const time = performance.now() * 0.00015;
  let t = (glow * 0.8 + Math.sin(time) * 0.2);
  t = Math.min(Math.max(t, 0), 1);

  const c = getColor(t);

  // ğŸ”¥ ç™ºå…‰ã‚µã‚¤ã‚º
  const radius = 30 + glow * 80;

  screen.style.background = `
    radial-gradient(
      circle at center,
      hsla(${c.h}, ${c.s}%, ${c.l + 20}%, 0.95) 0%,
      hsla(${c.h}, ${c.s}%, ${c.l}%, 0.6) ${radius}%,
      hsla(${c.h}, ${c.s}%, ${c.l - 10}%, 0.25) ${radius + 15}%,
      rgba(0,0,0,1) 100%
    )
  `;

  requestAnimationFrame(animate);
}

document.body.addEventListener("touchstart", startMic, { once: true });
document.body.addEventListener("click", startMic, { once: true });
</script>
</body>
</html>
